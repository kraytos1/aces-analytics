<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Aces Analytics – Team Pitching</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050814;
        --bg-alt: #0b1020;
        --bg-card: #13192b;
        --accent: #22c55e;
        --accent-soft: rgba(34, 197, 94, 0.15);
        --accent-strong: rgba(34, 197, 94, 0.32);
        --accent-border: rgba(34, 197, 94, 0.5);
        --accent-text: #bbf7d0;
        --text: #f8fafc;
        --muted: #8b9bbf;
        --border-subtle: rgba(148, 163, 184, 0.18);
        --border-strong: rgba(148, 163, 184, 0.28);
        --positive: #2dd4bf;
        --negative: #f97373;
        --warning: #facc15;
        --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
        --shadow-subtle: 0 14px 35px rgba(15, 23, 42, 0.65);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top left, #1e293b 0, #020617 42%);
        color: var(--text);
        font-family: var(--font-sans);
        -webkit-font-smoothing: antialiased;
        line-height: 1.5;
      }

      main {
        max-width: 1200px;
        margin: 24px auto 48px;
        padding: 0 16px 16px;
      }

      .page-header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 18px;
      }

      .page-title-block {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      h1 {
        margin: 0;
        font-size: 1.9rem;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.3);
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .pill span {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 16px;
        min-height: 16px;
        border-radius: 999px;
        background: var(--accent);
        color: #020617;
        font-size: 0.65rem;
        font-weight: 700;
      }

      .subheading {
        font-size: 0.9rem;
        color: var(--muted);
        max-width: 640px;
      }

      .subheading strong {
        color: var(--accent-text);
        font-weight: 600;
      }

      .status-line {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .status-line strong {
        color: var(--accent-text);
      }

      .layout-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
        gap: 18px;
        align-items: flex-start;
      }

      @media (max-width: 980px) {
        .layout-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: radial-gradient(
            circle at top left,
            rgba(34, 197, 94, 0.1),
            transparent 54%
          ),
          radial-gradient(
            circle at bottom right,
            rgba(59, 130, 246, 0.06),
            transparent 58%
          ),
          var(--bg-card);
        border-radius: 18px;
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-soft);
        padding: 14px 16px 14px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .card-header .eyebrow {
        font-size: 0.7rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }

      .chip {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .chip strong {
        color: var(--accent-text);
        font-weight: 600;
      }

      .chip .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent);
      }

      .controls-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 3px;
        font-size: 0.75rem;
        color: var(--muted);
      }

      label {
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      select,
      input[type="file"],
      button,
      .btn {
        font-family: var(--font-sans);
      }

      select {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.6);
        border-radius: 999px;
        padding: 4px 9px;
        font-size: 0.8rem;
        color: var(--text);
        min-width: 150px;
      }

      select[multiple] {
        min-height: 80px;
        border-radius: 10px;
      }

      .btn {
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 0.8rem;
        border: 1px solid var(--accent-border);
        background: linear-gradient(135deg, var(--accent-strong), #22c55e);
        color: #0b1020;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 25px rgba(34, 197, 94, 0.45);
        white-space: nowrap;
      }

      .btn-secondary {
        background: transparent;
        color: var(--accent-text);
        border-color: rgba(148, 163, 184, 0.7);
        box-shadow: none;
      }

      .file-input-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .file-input-row input[type="file"] {
        font-size: 0.78rem;
        color: var(--muted);
      }

      .table-container {
        border-radius: 14px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.95);
        overflow: hidden;
        box-shadow: var(--shadow-subtle);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
      }

      thead {
        background: radial-gradient(
            circle at top left,
            rgba(56, 189, 248, 0.16),
            transparent 60%
          ),
          rgba(15, 23, 42, 0.96);
      }

      th,
      td {
        padding: 6px 8px;
        text-align: right;
        white-space: nowrap;
      }

      th:first-child,
      td:first-child {
        text-align: left;
      }

      th {
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      th.sort-asc::after,
      th.sort-desc::after {
        content: "";
        display: inline-block;
        margin-left: 4px;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
      }

      th.sort-asc::after {
        border-bottom: 6px solid var(--accent);
      }

      th.sort-desc::after {
        border-top: 6px solid var(--accent);
      }

      tbody tr:nth-child(odd) {
        background: rgba(15, 23, 42, 0.92);
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.86);
      }

      tbody tr.highlight-row {
        background: linear-gradient(
          90deg,
          rgba(34, 197, 94, 0.2),
          rgba(15, 23, 42, 0.9)
        );
      }

      tbody tr.highlight-row td:first-child {
        border-left: 3px solid var(--accent);
      }

      .name-cell {
        font-weight: 500;
        color: var(--text);
      }

      .name-cell small {
        display: block;
        font-size: 0.7rem;
        color: var(--muted);
      }

      .stat-good {
        color: var(--positive);
        font-weight: 500;
      }

      .stat-bad {
        color: var(--negative);
        font-weight: 500;
      }

      .stat-neutral {
        color: var(--muted);
      }

      .table-wrapper {
        max-height: 540px;
        overflow: auto;
      }

      .small-text {
        font-size: 0.74rem;
        color: var(--muted);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        font-size: 0.68rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
      }

      .tag span {
        color: var(--accent-text);
      }

      @media (max-width: 640px) {
        .page-header {
          gap: 8px;
        }
        .page-title-block h1 {
          font-size: 1.5rem;
        }
        .card {
          padding: 12px 12px 14px;
        }
        th,
        td {
          padding: 5px 6px;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="page-header">
        <div class="page-title-block">
          <h1>
            Team Pitching
            <span class="pill"><span>AA</span> Aces Analytics</span>
          </h1>
          <div class="subheading">
            Uses <strong>combined pitching stats</strong> across selected seasons,
            and recomputes ERA, WHIP, K/9, and BB/9 from the totals.
          </div>
          <div id="lastUpdated" class="status-line"></div>
        </div>
        <div class="tag">Internal · Staff View</div>
      </header>

      <section class="layout-grid">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="eyebrow">Input · Seasons &amp; CSV</div>
              <h2>Data Sources</h2>
            </div>
          </div>

          <div class="chip-row">
            <div class="chip">
              <span class="dot"></span>
              <span>Primary: GC Season Pitching Stats CSV</span>
            </div>
            <div class="chip">
              <span class="dot"></span>
              <span>Multi-season merge across the same pitchers</span>
            </div>
            <div class="chip">
              <span class="dot"></span>
              <span>Fallback: Manual CSV upload + localStorage</span>
            </div>
          </div>

          <div class="controls-row">
            <div class="control-group">
              <label for="seasonSelect">Seasons (multi-select)</label>
              <select id="seasonSelect" multiple size="4"></select>
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="applySeasonsBtn" class="btn">
                Apply Seasons
              </button>
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="clearSeasonsBtn" class="btn btn-secondary">
                Clear
              </button>
            </div>
          </div>

          <div class="file-input-row">
            <div class="control-group">
              <label for="csvFileInput">Manual CSV Upload (Fallback)</label>
              <input
                type="file"
                id="csvFileInput"
                accept=".csv,text/csv"
                aria-label="Upload GameChanger Season Pitching Stats CSV"
              />
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="clearStorageBtn" class="btn btn-secondary">
                Clear Saved CSV
              </button>
            </div>
          </div>

          <div id="loadStatus" class="status-line"></div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="eyebrow">Summary</div>
              <h2>Staff Overview</h2>
            </div>
          </div>
          <div class="small-text">
            Metrics are recomputed from combined totals of all selected seasons:
            <ul>
              <li>ERA = (ER * 9) / IP</li>
              <li>WHIP = (BB + H) / IP</li>
              <li>K/9 = (K * 9) / IP</li>
              <li>BB/9 = (BB * 9) / IP</li>
            </ul>
          </div>
        </section>
      </section>

      <section class="card" style="margin-top: 16px">
        <div class="card-header">
          <div>
            <div class="eyebrow">Output · Staff Leaderboard</div>
            <h2>Pitching Leaderboard</h2>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table id="pitchingTable">
              <thead>
                <tr>
                  <th data-key="PlayerName">Pitcher</th>
                  <th data-key="Uniform">#</th>
                  <th data-key="IP">IP</th>
                  <th data-key="ER">ER</th>
                  <th data-key="H">H</th>
                  <th data-key="BB">BB</th>
                  <th data-key="SO">K</th>
                  <th data-key="ERA">ERA</th>
                  <th data-key="WHIP">WHIP</th>
                  <th data-key="Kper9">K/9</th>
                  <th data-key="BBper9">BB/9</th>
                </tr>
              </thead>
              <tbody id="pitchingTbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <script>
      const STORAGE_KEY = "aces_pitching_csv_v1";

      function saveSeasonCsv(text) {
        try {
          window.localStorage.setItem(STORAGE_KEY, text);
        } catch (err) {
          console.warn("Unable to save CSV to localStorage", err);
        }
      }

      function loadSeasonCsv() {
        try {
          return window.localStorage.getItem(STORAGE_KEY);
        } catch (err) {
          console.warn("Unable to load CSV from localStorage", err);
          return null;
        }
      }

      function clearSeasonCsv() {
        try {
          window.localStorage.removeItem(STORAGE_KEY);
        } catch (err) {
          console.warn("Unable to clear CSV from localStorage", err);
        }
      }

      function parseCsv(text) {
        const lines = text.replace(/\r\n/g, "\n").split("\n");
        const header = lines[0].split(",").map((h) => h.trim());
        const rows = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const cells = [];
          let current = "";
          let inQuotes = false;
          for (let char of line) {
            if (char === '"') {
              inQuotes = !inQuotes;
              continue;
            }
            if (char === "," && !inQuotes) {
              cells.push(current);
              current = "";
            } else {
              current += char;
            }
          }
          cells.push(current);

          const row = {};
          header.forEach((key, idx) => {
            row[key] = cells[idx] !== undefined ? cells[idx].trim() : "";
          });
          rows.push(row);
        }
        return rows;
      }

      function toNumber(value) {
        if (value === null || value === undefined) return 0;
        const n = Number(String(value).replace(/[^0-9.-]/g, ""));
        return isNaN(n) ? 0 : n;
      }

      function safeGet(row, key) {
        return row[key] ?? row[key.toLowerCase()] ?? "";
      }

      function setLoadStatus(msg) {
        const el = document.getElementById("loadStatus");
        if (!el) return;
        el.innerHTML = msg || "";
      }

      async function fetchPitchingSeasons() {
        const select = document.getElementById("seasonSelect");
        if (!select) return;
        try {
          const res = await fetch("/api/pitching/seasons");
          if (!res.ok) throw new Error("HTTP " + res.status);
          const seasons = await res.json();
          select.innerHTML = "";
          if (!seasons || !seasons.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No pitching seasons found (API)";
            opt.disabled = true;
            select.appendChild(opt);
            return;
          }
          for (const s of seasons) {
            const opt = document.createElement("option");
            opt.value = s.id;
            opt.textContent = s.label || s.id;
            select.appendChild(opt);
          }
        } catch (err) {
          console.error("Error fetching pitching seasons", err);
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Error loading seasons (API)";
          opt.disabled = true;
          select.appendChild(opt);
        }
      }

      async function fetchPitchingCsvFromApi(seasonId) {
        const res = await fetch(`/api/pitching/csv/${encodeURIComponent(seasonId)}`);
        if (!res.ok) {
          throw new Error(
            `Failed to fetch pitching CSV for season ${seasonId}: HTTP ${res.status}`
          );
        }
        return await res.text();
      }

      async function fetchPitchingLastUpdated() {
        const el = document.getElementById("lastUpdated");
        if (!el) return;

        try {
          const res = await fetch("/api/pitching/last-updated");
          if (!res.ok) throw new Error("HTTP " + res.status);

          const data = await res.json();
          if (!data.last_updated) {
            el.textContent = "";
            return;
          }

          const dt = new Date(data.last_updated);
          if (!isNaN(dt.getTime())) {
            el.textContent = "Stats last updated: " + dt.toLocaleString();
          } else {
            el.textContent = "Stats last updated: " + data.last_updated;
          }
        } catch (err) {
          console.error("Error fetching pitching last-updated", err);
        }
      }

      function combinePitchingRows(rows) {
        const byKey = new Map();

        for (const row of rows) {
          const rawName = safeGet(row, "PlayerName") || safeGet(row, "Player");
          const uniform = (safeGet(row, "Uniform") || "").trim();
          const nameKey = (rawName || "").trim().toLowerCase();
          if (!nameKey) continue;

          const key = nameKey;
          const existing = byKey.get(key) || {
            PlayerName: rawName,
            Uniforms: new Set(),
            IP: 0,
            ER: 0,
            H: 0,
            BB: 0,
            SO: 0,
          };

          if (uniform) existing.Uniforms.add(uniform);

          existing.IP += toNumber(safeGet(row, "IP"));
          existing.ER += toNumber(safeGet(row, "ER"));
          existing.H += toNumber(safeGet(row, "H"));
          existing.BB += toNumber(safeGet(row, "BB"));
          existing.SO += toNumber(safeGet(row, "SO"));

          byKey.set(key, existing);
        }

        const out = [];
        for (const [, agg] of byKey) {
          const ip = agg.IP;
          const era = ip > 0 ? (agg.ER * 9) / ip : 0;
          const whip = ip > 0 ? (agg.BB + agg.H) / ip : 0;
          const kper9 = ip > 0 ? (agg.SO * 9) / ip : 0;
          const bbper9 = ip > 0 ? (agg.BB * 9) / ip : 0;

          out.push({
            PlayerName: agg.PlayerName,
            Uniform: Array.from(agg.Uniforms).join(" / "),
            IP: ip,
            ER: agg.ER,
            H: agg.H,
            BB: agg.BB,
            SO: agg.SO,
            ERA: era,
            WHIP: whip,
            Kper9: kper9,
            BBper9: bbper9,
          });
        }
        return out;
      }

      let currentSortKey = "ERA";
      let currentSortDir = "asc";
      let combinedPitching = null;

      function renderPitchingTable(rows) {
        const tbody = document.getElementById("pitchingTbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!rows || !rows.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 11;
          td.textContent = "No pitching data. Select seasons or upload a CSV.";
          td.classList.add("stat-neutral");
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const sorted = [...rows].sort((a, b) => {
          const ak = a[currentSortKey];
          const bk = b[currentSortKey];

          const aVal = typeof ak === "number" ? ak : toNumber(ak);
          const bVal = typeof bk === "number" ? bk : toNumber(bk);

          if (currentSortDir === "asc") {
            return aVal - bVal;
          } else {
            return bVal - aVal;
          }
        });

        sorted.forEach((row, idx) => {
          const tr = document.createElement("tr");
          if (idx < 3 && currentSortKey === "ERA") {
            tr.classList.add("highlight-row");
          }

          const nameTd = document.createElement("td");
          nameTd.className = "name-cell";
          nameTd.innerHTML = `${row.PlayerName || ""}${
            row.Uniform
              ? `<small>Uniform: ${row.Uniform}</small>`
              : ""
          }`;
          tr.appendChild(nameTd);

          function addTd(val, cls) {
            const td = document.createElement("td");
            td.textContent = val;
            if (cls) td.className = cls;
            tr.appendChild(td);
          }

          addTd(row.Uniform || "", "stat-neutral");
          addTd(row.IP.toFixed(1), "stat-neutral");
          addTd(row.ER, "stat-bad");
          addTd(row.H, "stat-bad");
          addTd(row.BB, "stat-bad");
          addTd(row.SO, "stat-good");
          addTd(row.ERA.toFixed(2), "stat-good");
          addTd(row.WHIP.toFixed(2), "stat-good");
          addTd(row.Kper9.toFixed(2), "stat-good");
          addTd(row.BBper9.toFixed(2), "stat-bad");

          tbody.appendChild(tr);
        });
      }

      function updatePitchingTableHeaderSortState() {
        const ths = document.querySelectorAll("#pitchingTable thead th");
        ths.forEach((th) => {
          th.classList.remove("sort-asc", "sort-desc");
          const key = th.getAttribute("data-key");
          if (key === currentSortKey) {
            th.classList.add(
              currentSortDir === "asc" ? "sort-asc" : "sort-desc"
            );
          }
        });
      }

      function attachPitchingHeaderSortHandlers() {
        const ths = document.querySelectorAll("#pitchingTable thead th");
        ths.forEach((th) => {
          th.addEventListener("click", () => {
            const key = th.getAttribute("data-key");
            if (!key) return;
            if (currentSortKey === key) {
              currentSortDir = currentSortDir === "asc" ? "desc" : "asc";
            } else {
              currentSortKey = key;
              currentSortDir = key === "PlayerName" ? "asc" : "desc";
            }
            updatePitchingTableHeaderSortState();
            if (combinedPitching) {
              renderPitchingTable(combinedPitching);
            }
          });
        });
      }

      function parsePitchingCsvText(text, { fromStorage = false } = {}) {
        if (!text) return;
        setLoadStatus(
          fromStorage
            ? "Loaded pitching stats from localStorage cache."
            : "Loaded pitching stats from selected seasons."
        );

        const rows = parseCsv(text);
        if (!rows || !rows.length) {
          setLoadStatus("Pitching CSV appears to be empty or invalid.");
          return;
        }

        const combined = combinePitchingRows(rows).filter((r) => r.IP > 0);
        combinedPitching = combined;
        renderPitchingTable(combined);
        updatePitchingTableHeaderSortState();
      }

      async function handleApplySeasonsClick() {
        const select = document.getElementById("seasonSelect");
        if (!select) return;
        const selected = Array.from(select.selectedOptions).map((opt) => opt.value);
        if (!selected.length) {
          setLoadStatus("Please select at least one season.");
          return;
        }

        setLoadStatus("Loading pitching CSVs from server for selected season(s)…");

        try {
          const texts = [];
          for (const id of selected) {
            const txt = await fetchPitchingCsvFromApi(id);
            texts.push(txt);
          }

          const allLines = [];
          let header = null;
          for (const t of texts) {
            const lines = t.replace(/\r\n/g, "\n").split("\n");
            if (!lines.length) continue;
            if (!header) {
              header = lines[0];
              allLines.push(header);
            }
            const dataLines = lines.slice(1).filter((ln) => ln.trim() !== "");
            allLines.push(...dataLines);
          }

          const mergedText = allLines.join("\n");
          saveSeasonCsv(mergedText);
          parsePitchingCsvText(mergedText, { fromStorage: false });
        } catch (err) {
          console.error("Error applying pitching seasons", err);
          setLoadStatus(
            "Error loading pitching seasons from API. You can still upload a CSV manually."
          );
        }
      }

      function handleCsvFileChange(evt) {
        const fileInput = evt.target;
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          if (!text) {
            setLoadStatus("Uploaded pitching file is empty.");
            return;
          }
          saveSeasonCsv(text);
          parsePitchingCsvText(text, { fromStorage: true });
        };
        reader.readAsText(file);
      }

      function handleClearStorageClick() {
        clearSeasonCsv();
        setLoadStatus(
          "Cleared locally cached pitching CSV. You can re-upload or select seasons."
        );
        combinedPitching = null;
        renderPitchingTable([]);
      }

      function handleClearSeasonsClick() {
        const select = document.getElementById("seasonSelect");
        if (select) {
          Array.from(select.options).forEach((opt) => (opt.selected = false));
        }
        setLoadStatus("Cleared selected pitching seasons. No server CSVs loaded.");
        combinedPitching = null;
        renderPitchingTable([]);
      }

      document.addEventListener("DOMContentLoaded", () => {
        attachPitchingHeaderSortHandlers();

        const fileInput = document.getElementById("csvFileInput");
        if (fileInput) {
          fileInput.addEventListener("change", handleCsvFileChange);
        }

        const clearBtn = document.getElementById("clearStorageBtn");
        if (clearBtn) {
          clearBtn.addEventListener("click", handleClearStorageClick);
        }

        const applyBtn = document.getElementById("applySeasonsBtn");
        if (applyBtn) {
          applyBtn.addEventListener("click", handleApplySeasonsClick);
        }

        const clearSeasonsBtn = document.getElementById("clearSeasonsBtn");
        if (clearSeasonsBtn) {
          clearSeasonsBtn.addEventListener("click", handleClearSeasonsClick);
        }

        const cached = loadSeasonCsv();
        if (cached) {
          parsePitchingCsvText(cached, { fromStorage: true });
        }

        fetchPitchingSeasons();
        fetchPitchingLastUpdated();
      });
    </script>
  </body>
</html>
