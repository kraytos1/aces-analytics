<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Aces Analytics – Team Hitting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050814;
        --bg-alt: #0b1020;
        --bg-card: #13192b;
        --accent: #ff8a3d;
        --accent-soft: rgba(255, 138, 61, 0.15);
        --accent-strong: rgba(255, 138, 61, 0.32);
        --accent-border: rgba(255, 138, 61, 0.5);
        --accent-text: #ffd9b7;
        --text: #f8fafc;
        --muted: #8b9bbf;
        --border-subtle: rgba(148, 163, 184, 0.18);
        --border-strong: rgba(148, 163, 184, 0.28);
        --positive: #2dd4bf;
        --negative: #f97373;
        --warning: #facc15;
        --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
        --shadow-subtle: 0 14px 35px rgba(15, 23, 42, 0.65);
        --chip-bg: rgba(15, 23, 42, 0.9);
        --chip-border: rgba(148, 163, 184, 0.5);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top left, #1e293b 0, #020617 42%);
        color: var(--text);
        font-family: var(--font-sans);
        -webkit-font-smoothing: antialiased;
        line-height: 1.5;
      }

      main {
        max-width: 1200px;
        margin: 24px auto 48px;
        padding: 0 16px 16px;
      }

      .page-header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 18px;
      }

      .page-title-block {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      h1 {
        margin: 0;
        font-size: 1.9rem;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.3);
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .pill span {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 16px;
        min-height: 16px;
        border-radius: 999px;
        background: var(--accent);
        color: #020617;
        font-size: 0.65rem;
        font-weight: 700;
      }

      .subheading {
        font-size: 0.9rem;
        color: var(--muted);
        max-width: 640px;
      }

      .subheading strong {
        color: var(--accent-text);
        font-weight: 600;
      }

      /* layout */

      .layout-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.35fr) minmax(0, 0.9fr);
        gap: 18px;
        align-items: flex-start;
      }

      @media (max-width: 980px) {
        .layout-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: radial-gradient(
            circle at top left,
            rgba(251, 146, 60, 0.08),
            transparent 54%
          ),
          radial-gradient(
            circle at bottom right,
            rgba(56, 189, 248, 0.04),
            transparent 58%
          ),
          var(--bg-card);
        border-radius: 18px;
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-soft);
        padding: 14px 16px 14px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .card-header .eyebrow {
        font-size: 0.7rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }

      .chip {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.7rem;
        border: 1px solid var(--chip-border);
        background: var(--chip-bg);
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .chip strong {
        color: var(--accent-text);
        font-weight: 600;
      }

      .chip .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent);
      }

      .controls-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 3px;
        font-size: 0.75rem;
        color: var(--muted);
      }

      label {
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      select,
      input[type="file"],
      button,
      .btn {
        font-family: var(--font-sans);
      }

      select {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.6);
        border-radius: 999px;
        padding: 4px 9px;
        font-size: 0.8rem;
        color: var(--text);
        min-width: 150px;
      }

      select[multiple] {
        min-height: 80px;
        border-radius: 10px;
      }

      .btn {
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 0.8rem;
        border: 1px solid var(--accent-border);
        background: linear-gradient(135deg, var(--accent-strong), #f97316);
        color: #0b1020;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 25px rgba(249, 115, 22, 0.45);
        white-space: nowrap;
      }

      .btn-secondary {
        background: transparent;
        color: var(--accent-text);
        border-color: rgba(148, 163, 184, 0.7);
        box-shadow: none;
      }

      .btn-icon {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
      }

      .file-input-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .file-input-row input[type="file"] {
        font-size: 0.78rem;
        color: var(--muted);
      }

      .status-line {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .status-line strong {
        color: var(--accent-text);
      }

      .status-line span.badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.55);
        background: rgba(15, 23, 42, 0.9);
        font-size: 0.7rem;
        color: var(--muted);
      }

      .status-line span.badge-indicator {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--accent);
      }

      .status-muted {
        color: rgba(148, 163, 184, 0.8);
      }

      /* table */

      .table-container {
        border-radius: 14px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.95);
        overflow: hidden;
        box-shadow: var(--shadow-subtle);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
      }

      thead {
        background: radial-gradient(
            circle at top left,
            rgba(248, 113, 113, 0.16),
            transparent 60%
          ),
          rgba(15, 23, 42, 0.96);
      }

      th,
      td {
        padding: 6px 8px;
        text-align: right;
        white-space: nowrap;
      }

      th:first-child,
      td:first-child {
        text-align: left;
      }

      th {
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      th.sort-asc::after,
      th.sort-desc::after {
        content: "";
        display: inline-block;
        margin-left: 4px;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
      }

      th.sort-asc::after {
        border-bottom: 6px solid var(--accent);
      }

      th.sort-desc::after {
        border-top: 6px solid var(--accent);
      }

      tbody tr:nth-child(odd) {
        background: rgba(15, 23, 42, 0.92);
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.86);
      }

      tbody tr.highlight-row {
        background: linear-gradient(
          90deg,
          rgba(251, 146, 60, 0.2),
          rgba(15, 23, 42, 0.9)
        );
      }

      tbody tr.highlight-row td:first-child {
        border-left: 3px solid var(--accent);
      }

      td.name-cell {
        font-weight: 500;
        color: var(--text);
      }

      td.name-cell small {
        display: block;
        font-size: 0.7rem;
        color: var(--muted);
      }

      td .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 1px 7px;
        border-radius: 999px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
      }

      td .badge-elite {
        border-color: rgba(34, 197, 94, 0.7);
        color: #bbf7d0;
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.2),
          rgba(15, 23, 42, 0.9)
        );
      }

      .stat-good {
        color: var(--positive);
        font-weight: 500;
      }

      .stat-bad {
        color: var(--negative);
        font-weight: 500;
      }

      .stat-neutral {
        color: var(--muted);
      }

      .sticky-header {
        position: sticky;
        top: 0;
        z-index: 5;
      }

      .table-wrapper {
        max-height: 540px;
        overflow: auto;
      }

      /* chart */

      .chart-card {
        position: relative;
      }

      .chart-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .chart-header-row h3 {
        margin: 0;
        font-size: 0.9rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.95);
      }

      .chart-legend {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        font-size: 0.72rem;
        color: var(--muted);
      }

      .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid var(--border-subtle);
      }

      .legend-swatch {
        width: 10px;
        height: 10px;
        border-radius: 999px;
      }

      .legend-swatch.avg {
        background: #f97316;
      }

      .legend-swatch.obp {
        background: #22c55e;
      }

      .legend-swatch.slg {
        background: #38bdf8;
      }

      .legend-swatch.ops {
        background: #e879f9;
      }

      .chart-container {
        position: relative;
        height: 280px;
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.94);
        padding: 6px;
        margin-top: 4px;
      }

      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .chart-empty {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        color: var(--muted);
      }

      /* misc */

      .small-text {
        font-size: 0.74rem;
        color: var(--muted);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        font-size: 0.68rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
      }

      .tag span {
        color: var(--accent-text);
      }

      .muted {
        color: var(--muted);
      }

      .season-select {
        min-width: 200px;
      }

      #loadStatus {
        font-size: 0.78rem;
        color: var(--muted);
      }

      #loadStatus strong {
        color: var(--accent-text);
      }

      /* mobile tweaks */

      @media (max-width: 640px) {
        .page-header {
          gap: 8px;
        }
        .page-title-block h1 {
          font-size: 1.5rem;
        }
        .card {
          padding: 12px 12px 14px;
        }
        th,
        td {
          padding: 5px 6px;
        }
        .controls-row {
          align-items: stretch;
        }
        select {
          width: 100%;
        }
        .file-input-row {
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="page-header">
        <div class="page-title-block">
          <h1>
            Team Hitting
            <span class="pill"
              ><span>AA</span> Aces Analytics · Internal</span
            >
          </h1>
          <div class="subheading">
            Uses combined <strong>GameChanger Season Stats CSVs</strong> pulled
            from your scraper or uploaded manually. Supports
            <strong>multi-season selection</strong> and recomputes AVG/OBP/SLG/OPS
            from the combined totals.
          </div>
          <div id="seasonBadge" class="status-line"></div>
          <div id="lastUpdated" class="status-line"></div>
        </div>
        <div class="tag">
          Built for <span>&nbsp;Delmarva Aces 12U&nbsp;</span>
        </div>
      </header>

      <section class="layout-grid">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="eyebrow">Input · Seasons &amp; CSV</div>
              <h2>Data Sources</h2>
            </div>
          </div>

          <div class="chip-row">
            <div class="chip">
              <span class="dot"></span>
              <span>Primary: GC Season Stats CSV</span>
            </div>
            <div class="chip">
              <span class="dot"></span>
              <span>Merge across seasons · Recalculate slash line</span>
            </div>
            <div class="chip">
              <span class="dot"></span>
              <span>Fallback: Manual CSV upload + localStorage</span>
            </div>
          </div>

          <div class="controls-row">
            <div class="control-group">
              <label for="seasonSelect">Seasons (multi-select)</label>
              <select
                id="seasonSelect"
                class="season-select"
                multiple
                size="4"
              ></select>
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="applySeasonsBtn" class="btn">
                <span class="btn-icon">✓</span>
                Apply Seasons
              </button>
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="clearSeasonsBtn" class="btn btn-secondary">
                Clear
              </button>
            </div>
          </div>

          <div class="file-input-row">
            <div class="control-group">
              <label for="csvFileInput">Manual CSV Upload (Fallback)</label>
              <input
                type="file"
                id="csvFileInput"
                accept=".csv,text/csv"
                aria-label="Upload GameChanger Season Stats CSV"
              />
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="clearStorageBtn" class="btn btn-secondary">
                Clear Saved CSV
              </button>
            </div>
          </div>

          <div id="loadStatus" class="status-line"></div>
        </section>

        <section class="card chart-card">
          <div class="chart-header-row">
            <h3>Team Slash Line · Combined Seasons</h3>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-swatch avg"></span>
                AVG
              </div>
              <div class="legend-item">
                <span class="legend-swatch obp"></span>
                OBP
              </div>
              <div class="legend-item">
                <span class="legend-swatch slg"></span>
                SLG
              </div>
              <div class="legend-item">
                <span class="legend-swatch ops"></span>
                OPS
              </div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="slashChart"></canvas>
            <div id="chartEmptyState" class="chart-empty" style="display: none">
              Select at least one season to see the combined slash line.
            </div>
          </div>
          <div class="small-text" style="margin-top: 6px">
            Team totals recompute per selected seasons; OPS is
            <code>OBP + SLG</code>. Use this as a quick visual health check
            over-time.
          </div>
        </section>
      </section>

      <section class="card" style="margin-top: 16px">
        <div class="card-header sticky-header">
          <div>
            <div class="eyebrow">Output · Leaderboard</div>
            <h2>Hitting Leaderboard</h2>
          </div>
          <div class="chip-row">
            <div class="chip">
              <span class="dot"></span>
              <span
                >Click any column header to re-sort; top rows highlight “dudes”.</span
              >
            </div>
            <div class="chip">
              <span class="dot"></span>
              <span>Min 1 PA; stats are combined across selected seasons.</span>
            </div>
          </div>
        </div>
        <div class="table-container">
          <div class="table-wrapper">
            <table id="hittingTable">
              <thead>
                <tr>
                  <th data-key="PlayerName">Player</th>
                  <th data-key="Uniform">#</th>
                  <th data-key="PA">PA</th>
                  <th data-key="AB">AB</th>
                  <th data-key="H">H</th>
                  <th data-key="Doubles">2B</th>
                  <th data-key="Triples">3B</th>
                  <th data-key="HomeRuns">HR</th>
                  <th data-key="RBI">RBI</th>
                  <th data-key="R">R</th>
                  <th data-key="BB">BB</th>
                  <th data-key="SO">K</th>
                  <th data-key="SB">SB</th>
                  <th data-key="AVG">AVG</th>
                  <th data-key="OBP">OBP</th>
                  <th data-key="SLG">SLG</th>
                  <th data-key="OPS">OPS</th>
                </tr>
              </thead>
              <tbody id="hittingTbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // --- Utilities ---

      function parseCsv(text) {
        const lines = text.replace(/\r\n/g, "\n").split("\n");
        const header = lines[0].split(",").map((h) => h.trim());
        const rows = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const cells = [];
          let current = "";
          let inQuotes = false;
          for (let char of line) {
            if (char === '"') {
              inQuotes = !inQuotes;
              continue;
            }
            if (char === "," && !inQuotes) {
              cells.push(current);
              current = "";
            } else {
              current += char;
            }
          }
          cells.push(current);

          const row = {};
          header.forEach((key, idx) => {
            row[key] = cells[idx] !== undefined ? cells[idx].trim() : "";
          });
          rows.push(row);
        }
        return rows;
      }

      function toNumber(value) {
        if (value === null || value === undefined) return 0;
        const n = Number(String(value).replace(/[^0-9.-]/g, ""));
        return isNaN(n) ? 0 : n;
      }

      function formatAvg(a) {
        if (isNaN(a)) return "";
        return a.toFixed(3).replace(/^0+/, "");
      }

      function formatRate(a) {
        if (isNaN(a)) return "";
        return a.toFixed(3).replace(/^0+/, "");
      }

            function normalizeKeyName(k) {
        return String(k || "")
          .toLowerCase()
          .replace(/[^a-z0-9]/g, "");
      }

      function safeGet(row, key) {
        if (!row) return "";

        // 1) direct match
        if (key in row && row[key] != null && row[key] !== "") {
          return row[key];
        }

        // 2) direct lowercase key
        const lowerKey = key.toLowerCase();
        if (
          lowerKey in row &&
          row[lowerKey] != null &&
          row[lowerKey] !== ""
        ) {
          return row[lowerKey];
        }

        // 3) normalized match: "PlayerName" vs "Player Name" vs "player_name"
        const targetNorm = normalizeKeyName(key);
        for (const k of Object.keys(row)) {
          if (normalizeKeyName(k) === targetNorm) {
            const val = row[k];
            if (val != null && val !== "") return val;
          }
        }

        return "";
      }


      // --- Local storage fallback ---

      const STORAGE_KEY = "aces_hitting_csv_v1";

      function saveSeasonCsv(text) {
        try {
          window.localStorage.setItem(STORAGE_KEY, text);
        } catch (err) {
          console.warn("Unable to save CSV to localStorage", err);
        }
      }

      function loadSeasonCsv() {
        try {
          return window.localStorage.getItem(STORAGE_KEY);
        } catch (err) {
          console.warn("Unable to load CSV from localStorage", err);
          return null;
        }
      }

      function clearSeasonCsv() {
        try {
          window.localStorage.removeItem(STORAGE_KEY);
        } catch (err) {
          console.warn("Unable to clear CSV from localStorage", err);
        }
      }

      // --- State ---

      let currentSortKey = "OPS";
      let currentSortDir = "desc";
      let chartInstance = null;
      let combinedTotals = null;

      // --- Backend season list & CSV loading ---

      async function fetchHittingSeasons() {
        const select = document.getElementById("seasonSelect");
        if (!select) return;
        try {
          const res = await fetch("/api/hitting/seasons");
          if (!res.ok) throw new Error("HTTP " + res.status);
          const seasons = await res.json();
          select.innerHTML = "";
          if (!seasons || !seasons.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No seasons found (API)";
            opt.disabled = true;
            select.appendChild(opt);
            return;
          }
          for (const s of seasons) {
            const opt = document.createElement("option");
            opt.value = s.id;
            opt.textContent = s.label || s.id;
            select.appendChild(opt);
          }
        } catch (err) {
          console.error("Error fetching hitting seasons", err);
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Error loading seasons (API)";
          opt.disabled = true;
          select.appendChild(opt);
        }
      }

      async function fetchSeasonCsvFromApi(seasonId) {
        const res = await fetch(`/api/hitting/csv/${encodeURIComponent(seasonId)}`);
        if (!res.ok) {
          throw new Error(`Failed to fetch CSV for season ${seasonId}: HTTP ${res.status}`);
        }
        return await res.text();
      }

      // --- Last-updated helper for Hitting ---

      async function fetchHittingLastUpdated() {
        const el = document.getElementById("lastUpdated");
        if (!el) return;

        try {
          const res = await fetch("/api/hitting/last-updated");
          if (!res.ok) throw new Error("HTTP " + res.status);

          const data = await res.json();
          if (!data.last_updated) {
            el.textContent = "";
            return;
          }

          const dt = new Date(data.last_updated);
          if (!isNaN(dt.getTime())) {
            el.textContent = "Stats last updated: " + dt.toLocaleString();
          } else {
            el.textContent = "Stats last updated: " + data.last_updated;
          }
        } catch (err) {
          console.error("Error fetching hitting last-updated", err);
        }
      }

      // --- Main processing ---

      function updateSeasonBadge(fromStorage) {
        const el = document.getElementById("seasonBadge");
        if (!el) return;
        if (fromStorage) {
          el.innerHTML =
            '<span class="badge"><span class="badge-indicator"></span> Using locally cached CSV (manual upload)</span>';
        } else {
          el.innerHTML =
            '<span class="badge"><span class="badge-indicator"></span> Using server CSVs (scraper pipeline)</span>';
        }
      }

      function setLoadStatus(msg) {
        const el = document.getElementById("loadStatus");
        if (!el) return;
        el.innerHTML = msg || "";
      }

      function getNum(row, keys) {
        // Try multiple possible header names for the same stat
        for (const key of keys) {
          const val = safeGet(row, key);
          if (val !== "" && val != null) {
            return toNumber(val);
          }
        }
        return 0;
      }

      function combineRowsAcrossSeasons(rows) {
        const byKey = new Map();

        for (const row of rows) {
          // Be flexible about how the name column is labeled
          const rawName =
            safeGet(row, "PlayerName") ||
            safeGet(row, "Player") ||
            safeGet(row, "Name") ||
            safeGet(row, "PlayerKey");

          // Same for uniform / jersey #
          const uniform =
            (safeGet(row, "Uniform") ||
              safeGet(row, "Jersey") ||
              safeGet(row, "JerseyNumber") ||
              safeGet(row, "Number") ||
              "").trim();

          const nameKey = (rawName || "").trim().toLowerCase();
          if (!nameKey) continue;

          const key = nameKey;
          const existing =
            byKey.get(key) || {
              PlayerName: rawName,
              Uniforms: new Set(),
              PA: 0,
              AB: 0,
              H: 0,
              Doubles: 0,
              Triples: 0,
              HomeRuns: 0,
              RBI: 0,
              R: 0,
              BB: 0,
              SO: 0,
              SB: 0,
            };

          if (uniform) existing.Uniforms.add(uniform);

          // Use flexible header mappings for each stat
          existing.PA += getNum(row, ["PA", "PlateAppearances"]);
          existing.AB += getNum(row, ["AB"]);
          existing.H += getNum(row, ["H", "Hits"]);
          existing.Doubles += getNum(row, ["Doubles", "2B"]);
          existing.Triples += getNum(row, ["Triples", "3B"]);
          existing.HomeRuns += getNum(row, ["HomeRuns", "HR"]);
          existing.RBI += getNum(row, ["RBI"]);
          existing.R += getNum(row, ["R", "Runs"]);
          existing.BB += getNum(row, ["BB", "BaseOnBalls", "Walks"]);
          existing.SO += getNum(row, ["SO", "K", "Strikeouts"]);
          existing.SB += getNum(row, ["SB", "StolenBases"]);

          byKey.set(key, existing);
        }

        const out = [];
        for (const [, agg] of byKey) {
          const pa = agg.PA || agg.AB + agg.BB;
          const ab = agg.AB;

          const singles = Math.max(
            0,
            agg.H - agg.Doubles - agg.Triples - agg.HomeRuns
          );
          const tb =
            singles +
            2 * agg.Doubles +
            3 * agg.Triples +
            4 * agg.HomeRuns;

          const avg = ab > 0 ? agg.H / ab : 0;
          const obp = pa > 0 ? (agg.H + agg.BB) / pa : 0;
          const slg = ab > 0 ? tb / ab : 0;
          const ops = obp + slg;

          out.push({
            PlayerName: agg.PlayerName,
            Uniform: Array.from(agg.Uniforms).join(" / "),
            PA: agg.PA,
            AB: agg.AB,
            H: agg.H,
            Doubles: agg.Doubles,
            Triples: agg.Triples,
            HomeRuns: agg.HomeRuns,
            RBI: agg.RBI,
            R: agg.R,
            BB: agg.BB,
            SO: agg.SO,
            SB: agg.SB,
            TB: tb,
            AVG: avg,
            OBP: obp,
            SLG: slg,
            OPS: ops,
          });
        }

        return out;
      }


      function renderTable(rows) {
        const tbody = document.getElementById("hittingTbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!rows || !rows.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 17;
          td.textContent = "No data. Select a season or upload a CSV.";
          td.classList.add("stat-neutral");
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const sorted = [...rows].sort((a, b) => {
          const ak = a[currentSortKey];
          const bk = b[currentSortKey];

          const aVal = typeof ak === "number" ? ak : toNumber(ak);
          const bVal = typeof bk === "number" ? bk : toNumber(bk);

          if (currentSortDir === "asc") {
            return aVal - bVal;
          } else {
            return bVal - aVal;
          }
        });

        sorted.forEach((row, idx) => {
          const tr = document.createElement("tr");
          if (idx < 3 && currentSortKey === "OPS") {
            tr.classList.add("highlight-row");
          }

          const nameTd = document.createElement("td");
          nameTd.className = "name-cell";
          nameTd.innerHTML = `${row.PlayerName || ""}${
            row.Uniform
              ? `<small>Uniform: ${row.Uniform}</small>`
              : ""
          }`;
          tr.appendChild(nameTd);

          function addTd(val, opts = {}) {
            const td = document.createElement("td");
            td.textContent = val;
            if (opts.className) td.className = opts.className;
            tr.appendChild(td);
          }

          addTd(row.Uniform || "");
          addTd(row.PA, { className: "stat-neutral" });
          addTd(row.AB, { className: "stat-neutral" });
          addTd(row.H, { className: "stat-good" });
          addTd(row.Doubles || 0, { className: "stat-good" });
          addTd(row.Triples || 0, { className: "stat-good" });
          addTd(row.HomeRuns || 0, { className: "stat-good" });
          addTd(row.RBI || 0, { className: "stat-good" });
          addTd(row.R || 0, { className: "stat-good" });
          addTd(row.BB || 0, { className: "stat-neutral" });
          addTd(row.SO || 0, { className: "stat-bad" });
          addTd(row.SB || 0, { className: "stat-good" });

          addTd(formatAvg(row.AVG), { className: "stat-good" });
          addTd(formatRate(row.OBP), { className: "stat-good" });
          addTd(formatRate(row.SLG), { className: "stat-good" });
          addTd(formatRate(row.OPS), { className: "stat-good" });

          tbody.appendChild(tr);
        });
      }

      function updateTableHeaderSortState() {
        const ths = document.querySelectorAll("#hittingTable thead th");
        ths.forEach((th) => {
          th.classList.remove("sort-asc", "sort-desc");
          const key = th.getAttribute("data-key");
          if (key === currentSortKey) {
            th.classList.add(
              currentSortDir === "asc" ? "sort-asc" : "sort-desc"
            );
          }
        });
      }

      function attachHeaderSortHandlers() {
        const ths = document.querySelectorAll("#hittingTable thead th");
        ths.forEach((th) => {
          th.addEventListener("click", () => {
            const key = th.getAttribute("data-key");
            if (!key) return;
            if (currentSortKey === key) {
              currentSortDir = currentSortDir === "asc" ? "desc" : "asc";
            } else {
              currentSortKey = key;
              currentSortDir = key === "PlayerName" ? "asc" : "desc";
            }
            updateTableHeaderSortState();
            if (combinedTotals) {
              renderTable(combinedTotals);
            }
          });
        });
      }

      function updateTeamChart(rows) {
        const ctx = document.getElementById("slashChart");
        const emptyState = document.getElementById("chartEmptyState");
        if (!ctx || !emptyState) return;

        if (!rows || !rows.length) {
          emptyState.style.display = "flex";
          if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
          }
          return;
        }

        emptyState.style.display = "none";

        let totalAB = 0;
        let totalH = 0;
        let totalBB = 0;
        let totalTB = 0;
        let totalPA = 0;

        for (const row of rows) {
          totalAB += row.AB || 0;
          totalH += row.H || 0;
          totalBB += row.BB || 0;
          totalTB += row.TB || 0;
          totalPA += row.PA || 0;
        }

        const teamAVG = totalAB > 0 ? totalH / totalAB : 0;
        const teamOBP = totalPA > 0 ? (totalH + totalBB) / totalPA : 0;
        const teamSLG = totalAB > 0 ? totalTB / totalAB : 0;
        const teamOPS = teamOBP + teamSLG;

        const data = {
          labels: ["AVG", "OBP", "SLG", "OPS"],
          datasets: [
            {
              label: "Team Slash Line",
              data: [teamAVG, teamOBP, teamSLG, teamOPS],
              borderWidth: 2,
              tension: 0.3,
              fill: false,
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (val) => val.toFixed(3),
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y;
                  return `${ctx.label}: ${v.toFixed(3)}`;
                },
              },
            },
          },
        };

        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
          type: "line",
          data,
          options,
        });
      }

      function parseSeasonCsvText(text, { fromStorage = false } = {}) {
        if (!text) return;
        setLoadStatus(
          fromStorage
            ? "Loaded stats from localStorage cache."
            : "Loaded stats from selected seasons."
        );

        const rows = parseCsv(text);
        if (!rows || !rows.length) {
          setLoadStatus("CSV appears to be empty or invalid.");
          return;
        }

        const combined = combineRowsAcrossSeasons(rows).filter(
          (r) => r.PA > 0 || r.AB > 0
        );

        combinedTotals = combined;
        renderTable(combined);
        updateTableHeaderSortState();
        updateTeamChart(combined);
      }

      // --- Event handlers ---

      async function handleApplySeasonsClick() {
        const select = document.getElementById("seasonSelect");
        if (!select) return;
        const selected = Array.from(select.selectedOptions).map((opt) => opt.value);
        if (!selected.length) {
          setLoadStatus("Please select at least one season.");
          return;
        }

        setLoadStatus("Loading CSVs from server for selected season(s)…");

        try {
          const texts = [];
          for (const id of selected) {
            const txt = await fetchSeasonCsvFromApi(id);
            texts.push(txt);
          }

          const allLines = [];
          let header = null;
          for (const t of texts) {
            const lines = t.replace(/\r\n/g, "\n").split("\n");
            if (!lines.length) continue;
            if (!header) {
              header = lines[0];
              allLines.push(header);
            }
            const dataLines = lines.slice(1).filter((ln) => ln.trim() !== "");
            allLines.push(...dataLines);
          }

          const mergedText = allLines.join("\n");
          saveSeasonCsv(mergedText);
          updateSeasonBadge(false);
          parseSeasonCsvText(mergedText, { fromStorage: false });
        } catch (err) {
          console.error("Error applying selected seasons", err);
          setLoadStatus(
            "Error loading seasons from API. You can still upload a CSV manually."
          );
        }
      }

      function handleCsvFileChange(evt) {
        const fileInput = evt.target;
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          if (!text) {
            setLoadStatus("Uploaded file is empty.");
            return;
          }
          saveSeasonCsv(text);
          updateSeasonBadge(true);
          parseSeasonCsvText(text, { fromStorage: true });
        };
        reader.readAsText(file);
      }

      function handleClearStorageClick() {
        clearSeasonCsv();
        setLoadStatus("Cleared locally cached CSV. You can re-upload or select seasons.");
        combinedTotals = null;
        renderTable([]);
        updateTeamChart([]);
      }

      function handleClearSeasonsClick() {
        const select = document.getElementById("seasonSelect");
        if (select) {
          Array.from(select.options).forEach((opt) => (opt.selected = false));
        }
        setLoadStatus("Cleared selected seasons. No server CSVs loaded.");
        combinedTotals = null;
        renderTable([]);
        updateTeamChart([]);
      }

      document.addEventListener("DOMContentLoaded", () => {
        attachHeaderSortHandlers();

        const fileInput = document.getElementById("csvFileInput");
        if (fileInput) {
          fileInput.addEventListener("change", handleCsvFileChange);
        }

        const clearBtn = document.getElementById("clearStorageBtn");
        if (clearBtn) {
          clearBtn.addEventListener("click", handleClearStorageClick);
        }

        const applyBtn = document.getElementById("applySeasonsBtn");
        if (applyBtn) {
          applyBtn.addEventListener("click", handleApplySeasonsClick);
        }

        const clearSeasonsBtn = document.getElementById("clearSeasonsBtn");
        if (clearSeasonsBtn) {
          clearSeasonsBtn.addEventListener("click", handleClearSeasonsClick);
        }

        const cached = loadSeasonCsv();
        updateSeasonBadge(!!cached);
        if (cached) {
          parseSeasonCsvText(cached, { fromStorage: true });
        }
        fetchHittingSeasons();
        fetchHittingLastUpdated();
      });
    </script>
  </body>
</html>
