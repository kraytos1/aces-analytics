<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Aces Analytics – Player Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050814;
        --bg-alt: #0b1020;
        --bg-card: #13192b;
        --accent: #f97316;
        --accent-soft: rgba(249, 115, 22, 0.18);
        --accent-strong: rgba(249, 115, 22, 0.32);
        --accent-border: rgba(249, 115, 22, 0.5);
        --accent-text: #fed7aa;
        --text: #f8fafc;
        --muted: #8b9bbf;
        --border-subtle: rgba(148, 163, 184, 0.18);
        --border-strong: rgba(148, 163, 184, 0.28);
        --positive: #2dd4bf;
        --negative: #f97373;
        --warning: #facc15;
        --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
        --shadow-subtle: 0 14px 35px rgba(15, 23, 42, 0.65);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top left, #1e293b 0, #020617 42%);
        color: var(--text);
        font-family: var(--font-sans);
        -webkit-font-smoothing: antialiased;
        line-height: 1.5;
      }

      main {
        max-width: 1200px;
        margin: 24px auto 48px;
        padding: 0 16px 16px;
      }

      .page-header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 18px;
      }

      .page-title-block {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      h1 {
        margin: 0;
        font-size: 1.9rem;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.3);
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .pill span {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 16px;
        min-height: 16px;
        border-radius: 999px;
        background: var(--accent);
        color: #020617;
        font-size: 0.65rem;
        font-weight: 700;
      }

      .subheading {
        font-size: 0.9rem;
        color: var(--muted);
        max-width: 640px;
      }

      .subheading strong {
        color: var(--accent-text);
        font-weight: 600;
      }

      .status-line {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .status-line strong {
        color: var(--accent-text);
      }

      .layout-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
        gap: 18px;
        align-items: flex-start;
      }

      @media (max-width: 980px) {
        .layout-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: radial-gradient(
            circle at top left,
            rgba(249, 115, 22, 0.14),
            transparent 54%
          ),
          radial-gradient(
            circle at bottom right,
            rgba(56, 189, 248, 0.08),
            transparent 58%
          ),
          var(--bg-card);
        border-radius: 18px;
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-soft);
        padding: 14px 16px 14px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .card-header .eyebrow {
        font-size: 0.7rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .controls-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: flex-end;
        margin-bottom: 10px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 3px;
        font-size: 0.75rem;
        color: var(--muted);
      }

      label {
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      input[type="text"],
      input[type="file"],
      select,
      button {
        font-family: var(--font-sans);
      }

      input[type="text"],
      select {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 6px 10px;
        font-size: 0.8rem;
        color: var(--text);
        min-width: 160px;
      }

      .btn {
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 0.8rem;
        border: 1px solid var(--accent-border);
        background: linear-gradient(135deg, var(--accent-strong), #f97316);
        color: #0b1020;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 25px rgba(249, 115, 22, 0.45);
        white-space: nowrap;
      }

      .btn-secondary {
        background: transparent;
        color: var(--accent-text);
        border-color: rgba(148, 163, 184, 0.7);
        box-shadow: none;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        font-size: 0.68rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
      }

      .tag span {
        color: var(--accent-text);
      }

      .player-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }

      .player-initials {
        width: 48px;
        height: 48px;
        border-radius: 999px;
        border: 2px solid var(--accent-border);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(
          circle at top left,
          var(--accent-soft),
          rgba(15, 23, 42, 0.95)
        );
        font-weight: 700;
        font-size: 1.3rem;
        color: var(--accent-text);
      }

      .player-basic {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .player-basic h2 {
        margin: 0;
        font-size: 1.4rem;
      }

      .player-basic .meta {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .pill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
      }

      .pill-small {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.6);
        font-size: 0.7rem;
        color: var(--muted);
      }

      .pill-small strong {
        color: var(--accent-text);
      }

      .pill-small .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent);
      }

      .stat-blocks {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
        margin-top: 10px;
      }

      .stat-block {
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.92);
        padding: 6px 8px;
        font-size: 0.8rem;
      }

      .stat-block-label {
        font-size: 0.68rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .stat-block-value {
        font-size: 1.05rem;
        font-weight: 600;
        margin-top: 2px;
      }

      .stat-block-footnote {
        font-size: 0.68rem;
        color: var(--muted);
        margin-top: 2px;
      }

      .stat-block-good .stat-block-value {
        color: var(--positive);
      }

      .stat-block-bad .stat-block-value {
        color: var(--negative);
      }

      .subcard {
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px dashed rgba(148, 163, 184, 0.35);
      }

      .subcard-title {
        font-size: 0.8rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.95);
        margin-bottom: 6px;
      }

      .subcard-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }

      .subcard-stat-label {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .subcard-stat-value {
        font-size: 0.9rem;
        font-weight: 500;
      }

      .subcard-stat-value.good {
        color: var(--positive);
      }

      .subcard-stat-value.bad {
        color: var(--negative);
      }

      .subcard-stat-value.neutral {
        color: var(--muted);
      }

      .small-text {
        font-size: 0.74rem;
        color: var(--muted);
      }

      .file-input-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .file-input-row input[type="file"] {
        font-size: 0.78rem;
        color: var(--muted);
      }

      #loadStatus {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .placeholder {
        font-size: 0.9rem;
        color: var(--muted);
        padding: 12px 0;
      }

      .chart-card {
        margin-top: 10px;
      }

      @media (max-width: 640px) {
        .page-header {
          gap: 8px;
        }
        .page-title-block h1 {
          font-size: 1.5rem;
        }
        .card {
          padding: 12px 12px 14px;
        }
        .stat-blocks,
        .subcard-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="page-header">
        <div class="page-title-block">
          <h1>
            Player Explorer
            <span class="pill"><span>AA</span> Aces Analytics</span>
          </h1>
          <div class="subheading">
            Upload the same <strong>GameChanger Season Stats CSV</strong> and use
            this to drill into a single player’s combined hitting (and pitching if
            present) across all selected seasons.
          </div>
          <div id="lastUpdated" class="status-line"></div>
        </div>
        <div class="tag">
          Internal · <span>&nbsp;Coaches/Parents&nbsp;</span>
        </div>
      </header>

      <section class="layout-grid">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="eyebrow">Input · Player &amp; CSV</div>
              <h2>Search &amp; Load</h2>
            </div>
          </div>

          <div class="controls-row">
            <div class="control-group">
              <label for="playerSearch">Player Name</label>
              <input
                type="text"
                id="playerSearch"
                placeholder="Start typing a name..."
                autocomplete="off"
              />
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <select id="playerSelect">
                <option value="">Select player...</option>
              </select>
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="loadPlayerBtn" class="btn">Load Player</button>
            </div>
          </div>

          <div class="file-input-row">
            <div class="control-group">
              <label for="csvFileInput">Season Stats CSV (Hitting + Pitching)</label>
              <input
                type="file"
                id="csvFileInput"
                accept=".csv,text/csv"
                aria-label="Upload combined season stats CSV"
              />
            </div>
            <div class="control-group">
              <label>&nbsp;</label>
              <button id="clearStorageBtn" class="btn btn-secondary">
                Clear Saved CSV
              </button>
            </div>
          </div>

          <div id="loadStatus"></div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="eyebrow">Output · Player Card</div>
              <h2>Profile</h2>
            </div>
          </div>
          <div id="playerCard">
            <div class="placeholder">
              Select a player and load stats to see a combined hitting/pitching
              card.
            </div>
          </div>
        </section>
      </section>
    </main>

    <script>
      const STORAGE_KEY = "aces_player_csv_v1";

      function saveSeasonCsv(text) {
        try {
          window.localStorage.setItem(STORAGE_KEY, text);
        } catch (err) {
          console.warn("Unable to save CSV to localStorage", err);
        }
      }

      function loadSeasonCsv() {
        try {
          return window.localStorage.getItem(STORAGE_KEY);
        } catch (err) {
          console.warn("Unable to load CSV from localStorage", err);
          return null;
        }
      }

      function clearSeasonCsv() {
        try {
          window.localStorage.removeItem(STORAGE_KEY);
        } catch (err) {
          console.warn("Unable to clear CSV from localStorage", err);
        }
      }

      function parseCsv(text) {
        const lines = text.replace(/\r\n/g, "\n").split("\n");
        const header = lines[0].split(",").map((h) => h.trim());
        const rows = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const cells = [];
          let current = "";
          let inQuotes = false;
          for (let char of line) {
            if (char === '"') {
              inQuotes = !inQuotes;
              continue;
            }
            if (char === "," && !inQuotes) {
              cells.push(current);
              current = "";
            } else {
              current += char;
            }
          }
          cells.push(current);

          const row = {};
          header.forEach((key, idx) => {
            row[key] = cells[idx] !== undefined ? cells[idx].trim() : "";
          });
          rows.push(row);
        }
        return rows;
      }

      function toNumber(value) {
        if (value === null || value === undefined) return 0;
        const n = Number(String(value).replace(/[^0-9.-]/g, ""));
        return isNaN(n) ? 0 : n;
      }

      function safeGet(row, key) {
        return row[key] ?? row[key.toLowerCase()] ?? "";
      }

      function setLoadStatus(msg) {
        const el = document.getElementById("loadStatus");
        if (!el) return;
        el.textContent = msg || "";
      }

      async function fetchPlayerLastUpdated() {
        const el = document.getElementById("lastUpdated");
        if (!el) return;

        try {
          const res = await fetch("/api/hitting/last-updated");
          if (!res.ok) throw new Error("HTTP " + res.status);

          const data = await res.json();
          if (!data.last_updated) {
            el.textContent = "";
            return;
          }

          const dt = new Date(data.last_updated);
          if (!isNaN(dt.getTime())) {
            el.textContent = "Stats last updated: " + dt.toLocaleString();
          } else {
            el.textContent = "Stats last updated: " + data.last_updated;
          }
        } catch (err) {
          console.error("Error fetching player last-updated", err);
        }
      }

      let allRows = [];
      let playersIndex = [];

      function buildPlayersIndex(rows) {
        const map = new Map();
        for (const row of rows) {
          const rawName =
            safeGet(row, "PlayerName") || safeGet(row, "Player") || "";
          const name = rawName.trim();
          if (!name) continue;

          const key = name.toLowerCase();
          const uniform = (safeGet(row, "Uniform") || "").trim();

          const existing = map.get(key) || { name, uniforms: new Set() };
          if (uniform) existing.uniforms.add(uniform);
          map.set(key, existing);
        }

        playersIndex = Array.from(map.values())
          .map((p) => ({
            name: p.name,
            display: p.uniforms.size
              ? `${p.name} (#${Array.from(p.uniforms).join("/")})`
              : p.name,
            key: p.name.toLowerCase(),
          }))
          .sort((a, b) => a.name.localeCompare(b.name));

        const select = document.getElementById("playerSelect");
        if (select) {
          select.innerHTML = '<option value="">Select player...</option>';
          playersIndex.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.key;
            opt.textContent = p.display;
            select.appendChild(opt);
          });
        }
      }

      function formatAvg(value) {
        if (!value || isNaN(value)) return "";
        return value.toFixed(3).replace(/^0+/, "");
      }

      function formatRate(value) {
        if (!value || isNaN(value)) return "";
        return value.toFixed(3).replace(/^0+/, "");
      }

      function buildPlayerStats(playerKey) {
        const hittingAgg = {
          PA: 0,
          AB: 0,
          H: 0,
          R: 0,
          RBI: 0,
          BB: 0,
          SO: 0,
          Doubles: 0,
          Triples: 0,
          HomeRuns: 0,
          SB: 0,
          TB: 0,
        };

        const pitchingAgg = {
          IP: 0,
          ER: 0,
          H: 0,
          BB: 0,
          SO: 0,
        };

        let displayName = "";
        const uniforms = new Set();

        for (const row of allRows) {
          const rawName =
            safeGet(row, "PlayerName") || safeGet(row, "Player") || "";
          const name = rawName.trim();
          if (!name) continue;
          if (name.toLowerCase() !== playerKey) continue;

          displayName = name;
          const uniform = (safeGet(row, "Uniform") || "").trim();
          if (uniform) uniforms.add(uniform);

          const ab = toNumber(safeGet(row, "AB"));
          const h = toNumber(safeGet(row, "H"));
          const r = toNumber(safeGet(row, "R"));
          const rbi = toNumber(safeGet(row, "RBI"));
          const bb = toNumber(safeGet(row, "BB"));
          const so = toNumber(safeGet(row, "SO"));
          const doubles = toNumber(safeGet(row, "Doubles"));
          const triples = toNumber(safeGet(row, "Triples"));
          const hr = toNumber(safeGet(row, "HomeRuns"));
          const sb = toNumber(safeGet(row, "SB"));
          const tb = toNumber(safeGet(row, "TB"));

          const pa = toNumber(safeGet(row, "PA")) || ab + bb;

          hittingAgg.PA += pa;
          hittingAgg.AB += ab;
          hittingAgg.H += h;
          hittingAgg.R += r;
          hittingAgg.RBI += rbi;
          hittingAgg.BB += bb;
          hittingAgg.SO += so;
          hittingAgg.Doubles += doubles;
          hittingAgg.Triples += triples;
          hittingAgg.HomeRuns += hr;
          hittingAgg.SB += sb;
          hittingAgg.TB += tb;

          const ip = toNumber(safeGet(row, "IP"));
          const er = toNumber(safeGet(row, "ER"));
          const ph = toNumber(safeGet(row, "PitchingH") || safeGet(row, "H"));
          const pbb = toNumber(safeGet(row, "PitchingBB") || safeGet(row, "BB"));
          const pso = toNumber(safeGet(row, "PitchingSO") || safeGet(row, "SO"));

          pitchingAgg.IP += ip;
          pitchingAgg.ER += er;
          pitchingAgg.H += ph;
          pitchingAgg.BB += pbb;
          pitchingAgg.SO += pso;
        }

        const singleCount = Math.max(
          0,
          hittingAgg.H -
            hittingAgg.Doubles -
            hittingAgg.Triples -
            hittingAgg.HomeRuns
        );
        const computedTB =
          singleCount +
          2 * hittingAgg.Doubles +
          3 * hittingAgg.Triples +
          4 * hittingAgg.HomeRuns;
        if (hittingAgg.TB === 0 && computedTB > 0) {
          hittingAgg.TB = computedTB;
        }

        const avg =
          hittingAgg.AB > 0 ? hittingAgg.H / hittingAgg.AB : 0;
        const obp =
          hittingAgg.PA > 0
            ? (hittingAgg.H + hittingAgg.BB) / hittingAgg.PA
            : 0;
        const slg =
          hittingAgg.AB > 0 ? hittingAgg.TB / hittingAgg.AB : 0;
        const ops = obp + slg;

        const ip = pitchingAgg.IP;
        const era = ip > 0 ? (pitchingAgg.ER * 9) / ip : 0;
        const whip =
          ip > 0 ? (pitchingAgg.BB + pitchingAgg.H) / ip : 0;
        const kper9 = ip > 0 ? (pitchingAgg.SO * 9) / ip : 0;
        const bbper9 = ip > 0 ? (pitchingAgg.BB * 9) / ip : 0;

        return {
          displayName,
          uniforms: Array.from(uniforms),
          hitting: {
            ...hittingAgg,
            AVG: avg,
            OBP: obp,
            SLG: slg,
            OPS: ops,
          },
          pitching: {
            ...pitchingAgg,
            ERA: era,
            WHIP: whip,
            Kper9: kper9,
            BBper9: bbper9,
          },
        };
      }

      function renderPlayerCard(stats) {
        const container = document.getElementById("playerCard");
        if (!container) return;

        if (!stats || !stats.displayName) {
          container.innerHTML =
            '<div class="placeholder">No stats found for this player in the loaded CSV.</div>';
          return;
        }

        const initials = stats.displayName
          .split(" ")
          .map((p) => p[0])
          .join("")
          .slice(0, 2)
          .toUpperCase();

        const uniformText =
          stats.uniforms && stats.uniforms.length
            ? "#" + stats.uniforms.join("/")
            : "N/A";

        const h = stats.hitting;
        const p = stats.pitching;

        const hittingSlash = `${formatAvg(h.AVG)} / ${formatRate(
          h.OBP
        )} / ${formatRate(h.SLG)} (OPS ${formatRate(h.OPS)})`;

        const pitchingLine =
          p.IP > 0
            ? `${p.IP.toFixed(1)} IP · ${p.ERA.toFixed(2)} ERA · ${p.WHIP.toFixed(
                2
              )} WHIP`
            : "No pitching data";

        container.innerHTML = `
      <div class="player-card-header">
        <div class="player-initials">${initials}</div>
        <div class="player-basic">
          <h2>${stats.displayName}</h2>
          <div class="meta">
            Uniform: <strong>${uniformText}</strong>
            ${
              h.PA > 0
                ? ` · ${h.PA} PA`
                : ""
            }
          </div>
          <div class="pill-row">
            <div class="pill-small">
              <span class="dot"></span>
              <span><strong>Slash:</strong> ${hittingSlash}</span>
            </div>
            <div class="pill-small">
              <span class="dot"></span>
              <span><strong>Pitching:</strong> ${pitchingLine}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="stat-blocks">
        <div class="stat-block stat-block-good">
          <div class="stat-block-label">OPS</div>
          <div class="stat-block-value">${formatRate(h.OPS)}</div>
          <div class="stat-block-footnote">OBP + SLG</div>
        </div>
        <div class="stat-block stat-block-good">
          <div class="stat-block-label">AVG</div>
          <div class="stat-block-value">${formatAvg(h.AVG)}</div>
          <div class="stat-block-footnote">${h.H} H / ${h.AB} AB</div>
        </div>
        <div class="stat-block">
          <div class="stat-block-label">RBI</div>
          <div class="stat-block-value">${h.RBI}</div>
          <div class="stat-block-footnote">Total Runs Batted In</div>
        </div>
        <div class="stat-block">
          <div class="stat-block-label">Runs</div>
          <div class="stat-block-value">${h.R}</div>
          <div class="stat-block-footnote">Total Runs Scored</div>
        </div>

        <div class="stat-block">
          <div class="stat-block-label">XBH</div>
          <div class="stat-block-value">
            ${h.Doubles + h.Triples + h.HomeRuns}
          </div>
          <div class="stat-block-footnote">
            ${h.Doubles} 2B · ${h.Triples} 3B · ${h.HomeRuns} HR
          </div>
        </div>
        <div class="stat-block">
          <div class="stat-block-label">BB / K</div>
          <div class="stat-block-value">${h.BB} / ${h.SO}</div>
          <div class="stat-block-footnote">Walks / Strikeouts</div>
        </div>
        <div class="stat-block">
          <div class="stat-block-label">SB</div>
          <div class="stat-block-value">${h.SB}</div>
          <div class="stat-block-footnote">Stolen Bases</div>
        </div>
        <div class="stat-block">
          <div class="stat-block-label">TB</div>
          <div class="stat-block-value">${h.TB}</div>
          <div class="stat-block-footnote">Total Bases (computed)</div>
        </div>
      </div>

      <div class="subcard">
        <div class="subcard-title">Pitching Snapshot</div>
        <div class="subcard-grid">
          <div>
            <div class="subcard-stat-label">IP</div>
            <div class="subcard-stat-value neutral">${p.IP.toFixed(1)}</div>
          </div>
          <div>
            <div class="subcard-stat-label">ERA</div>
            <div class="subcard-stat-value ${
              p.IP > 0 ? "good" : "neutral"
            }">${p.ERA.toFixed(2)}</div>
          </div>
          <div>
            <div class="subcard-stat-label">WHIP</div>
            <div class="subcard-stat-value ${
              p.IP > 0 ? "good" : "neutral"
            }">${p.WHIP.toFixed(2)}</div>
          </div>
          <div>
            <div class="subcard-stat-label">K/9</div>
            <div class="subcard-stat-value ${
              p.IP > 0 ? "good" : "neutral"
            }">${p.Kper9.toFixed(2)}</div>
          </div>
          <div>
            <div class="subcard-stat-label">BB/9</div>
            <div class="subcard-stat-value ${
              p.IP > 0 ? "bad" : "neutral"
            }">${p.BBper9.toFixed(2)}</div>
          </div>
          <div>
            <div class="subcard-stat-label">H</div>
            <div class="subcard-stat-value bad">${p.H}</div>
          </div>
          <div>
            <div class="subcard-stat-label">BB</div>
            <div class="subcard-stat-value bad">${p.BB}</div>
          </div>
          <div>
            <div class="subcard-stat-label">K</div>
            <div class="subcard-stat-value good">${p.SO}</div>
          </div>
        </div>
      </div>
    `;
      }

      function handleCsvFileChange(evt) {
        const fileInput = evt.target;
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          if (!text) {
            setLoadStatus("Uploaded file is empty.");
            return;
          }
          saveSeasonCsv(text);
          setLoadStatus("Loaded CSV into memory. Build the player index and search.");
          allRows = parseCsv(text);
          buildPlayersIndex(allRows);
        };
        reader.readAsText(file);
      }

      function handleClearStorageClick() {
        clearSeasonCsv();
        setLoadStatus("Cleared locally cached CSV.");
        allRows = [];
        playersIndex = [];
        const select = document.getElementById("playerSelect");
        if (select) {
          select.innerHTML = '<option value="">Select player...</option>';
        }
        const card = document.getElementById("playerCard");
        if (card) {
          card.innerHTML =
            '<div class="placeholder">Select a player and load stats to see a combined hitting/pitching card.</div>';
        }
      }

      function handleLoadPlayerClick() {
        const select = document.getElementById("playerSelect");
        if (!select) return;
        const key = select.value;
        if (!key) {
          setLoadStatus("Select a player first.");
          return;
        }
        if (!allRows || !allRows.length) {
          setLoadStatus("No CSV loaded. Upload a season stats CSV first.");
          return;
        }
        const stats = buildPlayerStats(key);
        renderPlayerCard(stats);
        setLoadStatus("");
      }

      function handlePlayerSearchInput(evt) {
        const term = (evt.target.value || "").toLowerCase();
        const select = document.getElementById("playerSelect");
        if (!select) return;

        if (!term) {
          select.innerHTML = '<option value="">Select player...</option>';
          playersIndex.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.key;
            opt.textContent = p.display;
            select.appendChild(opt);
          });
          return;
        }

        const filtered = playersIndex.filter((p) =>
          p.name.toLowerCase().includes(term)
        );

        select.innerHTML = '<option value="">Select player...</option>';
        filtered.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.key;
          opt.textContent = p.display;
          select.appendChild(opt);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const cached = loadSeasonCsv();
        if (cached) {
          allRows = parseCsv(cached);
          buildPlayersIndex(allRows);
          setLoadStatus("Loaded CSV from localStorage cache.");
        }

        const fileInput = document.getElementById("csvFileInput");
        if (fileInput) {
          fileInput.addEventListener("change", handleCsvFileChange);
        }

        const clearBtn = document.getElementById("clearStorageBtn");
        if (clearBtn) {
          clearBtn.addEventListener("click", handleClearStorageClick);
        }

        const loadPlayerBtn = document.getElementById("loadPlayerBtn");
        if (loadPlayerBtn) {
          loadPlayerBtn.addEventListener("click", handleLoadPlayerClick);
        }

        const searchInput = document.getElementById("playerSearch");
        if (searchInput) {
          searchInput.addEventListener("input", handlePlayerSearchInput);
        }

        fetchPlayerLastUpdated();
      });
    </script>
  </body>
</html>
